function doGet(e) {
  // Ambil parameter dari URL
  const id = e.parameter.id;
  const action = e.parameter.action;
  const role = e.parameter.role ? e.parameter.role.toLowerCase() : ""; // Proteksi jika role kosong
  
  const sheet = SpreadsheetApp.getActive().getSheetByName(CONFIG.SHEET_NAME);
  const rowIdx = findRowById(sheet, id);

  if (!rowIdx) return ContentService.createTextOutput("Error: ID [" + id + "] tidak ditemukan.");

  // Tentukan kolom target
  let headerKey = ""; 
  if (role === "atasan") {
    headerKey = CONFIG.COL_HEADERS.STATUS_ATASAN;
  } else if (role === "hr") {
    headerKey = CONFIG.COL_HEADERS.STATUS_HR;
  } 

  // VALIDASI 1: Cek apakah role dikirim dengan benar
  if (headerKey === "") {
    return ContentService.createTextOutput("Error: Parameter 'role' hilang atau salah. Gunakan &role=atasan atau &role=hr");
  }

  const targetCol = getColumnIndex(sheet, headerKey);

  // VALIDASI 2: Cek apakah kolom ada di Google Sheets
  if (!targetCol) {
    return ContentService.createTextOutput("Error: Kolom [" + headerKey + "] tidak ditemukan di Sheet. Cek header baris 1.");
  }

  const statusResult = (action === "setuju") ? "Disetujui" : "Ditolak";
  sheet.getRange(rowIdx, targetCol).setValue(statusResult);

  return ContentService.createTextOutput("Berhasil! " + role.toUpperCase() + " memberikan status: " + statusResult);
}

function onFormSubmit(e) {
  // Gunakan try-catch agar jika gagal, form tetap masuk tapi log tersimpan
  try {
    const sheet = e.range.getSheet(); // Mendapatkan sheet tempat data masuk
    
    // KUNCI PERBAIKAN: Validasi Nama Sheet
    // Jika data masuk BUKAN ke sheet "Pengajuan", hentikan skrip segera.
    if (sheet.getName() !== CONFIG.SHEET_NAME) {
      return; 
    }

    const row = e.range.getRow();
    
    // 1. Logika ID Unik (A-01, B-01, dst)
    const now = new Date();
    const monthList = "ABCDEFGHIJKL";
    const monthLetter = monthList.charAt(now.getMonth());
    const sequenceNum = row - 1; 
    const formattedSeq = ("00" + sequenceNum).slice(-2);
    const idUnik = monthLetter + "-" + formattedSeq;
    
    // 2. Ambil Index Kolom
    const colID = getColumnIndex(sheet, CONFIG.COL_HEADERS.ID_UNIK);
    const colStatusAtasan = getColumnIndex(sheet, CONFIG.COL_HEADERS.STATUS_ATASAN);
    const colStatusHR = getColumnIndex(sheet, CONFIG.COL_HEADERS.STATUS_HR);
    
    // 3. Update Baris (Hanya untuk sheet Pengajuan)
    if (colID) sheet.getRange(row, colID).setValue(idUnik);
    if (colStatusAtasan) sheet.getRange(row, colStatusAtasan).setValue("Pending");
    if (colStatusHR) sheet.getRange(row, colStatusHR).setValue("Pending");
    
  } catch (err) {
    Logger.log("Error onFormSubmit: " + err.toString());
  }
}