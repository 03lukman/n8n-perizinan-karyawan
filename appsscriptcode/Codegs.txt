function doGet(e) {
  try {
    // 1. Ambil parameter dengan proteksi spasi
    const id = e.parameter.id ? e.parameter.id.trim() : "";
    const action = e.parameter.action;
    const role = e.parameter.role ? e.parameter.role.toLowerCase() : "";
    
    if (!id) return ContentService.createTextOutput("Error: ID tidak ditemukan.");

    // 2. Akses sheet Pengajuan
    const sheet = SpreadsheetApp.getActive().getSheetByName(CONFIG.SHEET_NAME);
    const rowIdx = findRowById(sheet, id);

    if (!rowIdx) return ContentService.createTextOutput("Error: ID [" + id + "] tidak ditemukan.");

    // 3. Tentukan kolom target (Atasan atau HR)
    let headerKey = "";
    if (role === "atasan") {
      headerKey = CONFIG.COL_HEADERS.STATUS_ATASAN;
    } else if (role === "hr") {
      headerKey = CONFIG.COL_HEADERS.STATUS_HR;
    }

    if (headerKey === "") return ContentService.createTextOutput("Error: Role tidak valid.");

    const targetCol = getColumnIndex(sheet, headerKey);
    
    // --- LOGIKA ANTI KLIK GANDA (IDEMPOTENCY) ---
    // Cek nilai saat ini di kolom tersebut
    const currentStatus = sheet.getRange(rowIdx, targetCol).getValue();

    // Jika status sudah bukan 'Pending', maka akses ditolak
    if (currentStatus !== "Pending") {
      return ContentService.createTextOutput(
        "PERHATIAN: Pengajuan dengan ID " + id + " sudah pernah diproses sebelumnya.\n" +
        "Status saat ini: " + currentStatus + ".\n\n" +
        "Anda tidak dapat mengubah keputusan yang sudah masuk ke sistem."
      );
    }
    // --------------------------------------------

    // 4. Eksekusi perubahan jika status masih 'Pending'
    const statusResult = (action === "setuju") ? "Disetujui" : "Ditolak";
    sheet.getRange(rowIdx, targetCol).setValue(statusResult);

    return ContentService.createTextOutput(
      "BERHASIL: Terima kasih. Keputusan " + statusResult + " untuk ID " + id + " telah tercatat."
    );

  } catch (err) {
    return ContentService.createTextOutput("Terjadi kesalahan sistem: " + err.toString());
  }
}

/**
 * FUNGSI TRIGGER UTAMA (ON FORM SUBMIT)
 * REVISI: Menggunakan setValues() untuk mencegah trigger ganda di n8n
 */
function onFormSubmit(e) {
  try {
    const sheet = e.range.getSheet();
    const sheetName = sheet.getName();
    const responses = e.namedValues;
    const row = e.range.getRow();

    // --- LOGIKA 1: FORM UTAMA (TAB PENGAJUAN) ---
    if (sheetName === CONFIG.SHEET_NAME) {
      const emailUser = responses[CONFIG.COL_HEADERS.EMAIL_USER][0];
      const karyawan = getKaryawanDetails(emailUser); // Menggunakan helper.gs
      
      if (!karyawan) {
        Logger.log("Email tidak terdaftar: " + emailUser);
        return;
      }

      // Generate ID Unik (Contoh: B-01)
      const now = new Date();
      const monthLetter = "ABCDEFGHIJKL".charAt(now.getMonth());
      const idUnik = monthLetter + "-" + ("00" + (row - 1)).slice(-2);

      const col = {
        id: getColumnIndex(sheet, CONFIG.COL_HEADERS.ID_UNIK),
        nama: getColumnIndex(sheet, CONFIG.COL_HEADERS.NAMA),
        nik: getColumnIndex(sheet, CONFIG.COL_HEADERS.NIK),
        atasanEmail: getColumnIndex(sheet, CONFIG.COL_HEADERS.EMAIL_ATASAN),
        statusAtasan: getColumnIndex(sheet, CONFIG.COL_HEADERS.STATUS_ATASAN),
        statusHR: getColumnIndex(sheet, CONFIG.COL_HEADERS.STATUS_HR)
      };

      // Isi Data Otomatis (Hydration)
      if (col.id) sheet.getRange(row, col.id).setValue(idUnik);
      if (col.nama) sheet.getRange(row, col.nama).setValue(karyawan.nama);
      if (col.nik) sheet.getRange(row, col.nik).setValue(karyawan.nik);
      if (col.atasanEmail) sheet.getRange(row, col.atasanEmail).setValue(karyawan.atasan);
      if (col.statusAtasan) sheet.getRange(row, col.statusAtasan).setValue("Pending");
      if (col.statusHR) sheet.getRange(row, col.statusHR).setValue("Pending");

      // [TETAP] Rename & Pindah File
      const linkFile = responses[CONFIG.COL_HEADERS.FILE_PENGAJUAN] ? responses[CONFIG.COL_HEADERS.FILE_PENGAJUAN][0] : "";
      if (linkFile !== "") {
        executeRenameAndMove(linkFile, idUnik, karyawan.nama, "UTAMA");
      }
    } 
    
    // --- [TETAP] LOGIKA 2: FORM SUSULAN ---
    else if (sheetName === CONFIG.SHEET_SUSULAN) {
      syncSusulanToMain(responses);
    }

  } catch (err) {
    Logger.log("Error onFormSubmit: " + err.toString());
  }
}

/**
 * FUNGSI SINKRONISASI DATA SUSULAN (VERSI UPDATE NAMA)
 * Mencari ID Unik di Tab Pengajuan, mengambil nama asli, lalu menempelkan link.
 */
function syncSusulanToMain(responses) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const mainSheet = ss.getSheetByName(CONFIG.SHEET_NAME);
  
  const idUnik = responses[CONFIG.COL_HEADERS.ID_UNIK] ? responses[CONFIG.COL_HEADERS.ID_UNIK][0].trim() : null;
  const linkFile = responses[CONFIG.COL_HEADERS.LINK_SUSULAN] ? responses[CONFIG.COL_HEADERS.LINK_SUSULAN][0] : "";

  if (idUnik && linkFile !== "") {
    const rowIdx = findRowById(mainSheet, idUnik);
    if (rowIdx) {
      // --- LOGIKA BARU: AMBIL NAMA DARI TAB PENGAJUAN ---
      const colNama = getColumnIndex(mainSheet, CONFIG.COL_HEADERS.NAMA);
      const namaKaryawan = mainSheet.getRange(rowIdx, colNama).getValue() || "USER"; 
      // ------------------------------------------------
      
      const colSusulan = getColumnIndex(mainSheet, CONFIG.COL_HEADERS.LINK_SUSULAN);
      if (colSusulan) {
        // Tempel link ke kolom M di tab Pengajuan
        mainSheet.getRange(rowIdx, colSusulan).setValue(linkFile);
        
        // Rename menggunakan nama asli yang baru saja diambil
        executeRenameAndMove(linkFile, idUnik, namaKaryawan, "SUSULAN");
      }
    } else {
      Logger.log("Peringatan: ID " + idUnik + " tidak ditemukan!");
    }
  }
}

/**
 * FUNGSI FINAL RENAME & PINDAH FOLDER (VERSI KATEGORI BULAN)
 * BERUBAH: Sekarang mengecek/membuat folder bulan (A, B, C...) sebelum memindahkan file.
 */
function executeRenameAndMove(linksRaw, id, nama, label) {
  const TARGET_FOLDER_ID = CONFIG.TARGET_FOLDER_ID; 
  
  try {
    const parentFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
    
    // 1. [BARU] Tentukan Huruf Bulan (A=Januari, B=Februari, dst)
    const monthLetters = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L"];
    const currentMonthLetter = monthLetters[new Date().getMonth()];
    
    // 2. [BARU] Cari atau Buat Sub-Folder Huruf tersebut
    let targetFolder;
    const subFolders = parentFolder.getFoldersByName(currentMonthLetter);
    
    if (subFolders.hasNext()) {
      targetFolder = subFolders.next(); // Jika folder sudah ada (misal folder "B"), gunakan itu
    } else {
      targetFolder = parentFolder.createFolder(currentMonthLetter); // Jika belum ada, buat baru
    }

    const links = linksRaw.split(", ");
    
    links.forEach((url, index) => {
      const fileIdMatch = url.trim().match(/[-\w]{25,}/);
      if (fileIdMatch) {
        try {
          const file = DriveApp.getFileById(fileIdMatch[0]);
          const ext = file.getName().split('.').pop();
          
          const penomoran = links.length > 1 ? "_" + (index + 1) : ""; 
          const namaBaru = id + "_" + nama + "_" + label + penomoran + "." + ext;
          
          file.setName(namaBaru);
          
          // 3. [BERUBAH] Pindahkan ke targetFolder (Sub-folder bulan)
          file.moveTo(targetFolder); 

        } catch (e) {
          Logger.log("Gagal memproses file: " + e.toString());
        }
      }
    });
  } catch (err) {
    Logger.log("Error Folder: " + err.toString());
  }
}
