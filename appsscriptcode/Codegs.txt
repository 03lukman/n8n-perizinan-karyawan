function doGet(e) {
  try {
    // 1. Ambil parameter dengan proteksi spasi
    const id = e.parameter.id ? e.parameter.id.trim() : "";
    const action = e.parameter.action;
    const role = e.parameter.role ? e.parameter.role.toLowerCase() : "";
    
    if (!id) return ContentService.createTextOutput("Error: ID tidak ditemukan.");

    // 2. Akses sheet Pengajuan
    const sheet = SpreadsheetApp.getActive().getSheetByName(CONFIG.SHEET_NAME);
    const rowIdx = findRowById(sheet, id);

    if (!rowIdx) return ContentService.createTextOutput("Error: ID [" + id + "] tidak ditemukan.");

    // 3. Tentukan kolom target (Atasan atau HR)
    let headerKey = "";
    if (role === "atasan") {
      headerKey = CONFIG.COL_HEADERS.STATUS_ATASAN;
    } else if (role === "hr") {
      headerKey = CONFIG.COL_HEADERS.STATUS_HR;
    }

    if (headerKey === "") return ContentService.createTextOutput("Error: Role tidak valid.");

    const targetCol = getColumnIndex(sheet, headerKey);
    
    // --- LOGIKA ANTI KLIK GANDA (IDEMPOTENCY) ---
    // Cek nilai saat ini di kolom tersebut
    const currentStatus = sheet.getRange(rowIdx, targetCol).getValue();

    // Jika status sudah bukan 'Pending', maka akses ditolak
    if (currentStatus !== "Pending") {
      return ContentService.createTextOutput(
        "PERHATIAN: Pengajuan dengan ID " + id + " sudah pernah diproses sebelumnya.\n" +
        "Status saat ini: " + currentStatus + ".\n\n" +
        "Anda tidak dapat mengubah keputusan yang sudah masuk ke sistem."
      );
    }
    // --------------------------------------------

    // 4. Eksekusi perubahan jika status masih 'Pending'
    const statusResult = (action === "setuju") ? "Disetujui" : "Ditolak";
    sheet.getRange(rowIdx, targetCol).setValue(statusResult);

    return ContentService.createTextOutput(
      "BERHASIL: Terima kasih. Keputusan " + statusResult + " untuk ID " + id + " telah tercatat."
    );

  } catch (err) {
    return ContentService.createTextOutput("Terjadi kesalahan sistem: " + err.toString());
  }
}

/**
 * Fungsi ini otomatis berjalan saat ada data masuk dari Google Form.
 * Dirancang untuk menangani dua alur berbeda secara terisolasi.
 */
function onFormSubmit(e) {
  // Try-catch digunakan agar jika terjadi error, sistem tidak langsung mati total
  try {
    // 1. IDENTIFIKASI DATA MASUK
    const sheet = e.range.getSheet();         // Mengidentifikasi sheet mana yang menerima data
    const sheetName = sheet.getName();       // Mengambil nama sheet (Pengajuan atau Realisasi)
    const row = e.range.getRow();            // Mendapatkan nomor baris tempat data baru masuk
    const responses = e.namedValues;          // Mengambil seluruh jawaban dari Google Form dalam bentuk objek

    // 2. GERBANG PEMISAH LOGIKA (TIDAK SALING MENGGANGGU)
    
    // --- BLOK KHUSUS PENGAJUAN ---
    if (sheetName === CONFIG.SHEET_NAME) {
      
      // A. Membuat ID Unik (Contoh: B-05) berdasarkan Bulan dan Nomor Baris
      const now = new Date();
      const monthLetter = "ABCDEFGHIJKL".charAt(now.getMonth());
      const idUnik = monthLetter + "-" + ("00" + (row - 1)).slice(-2);
      
      // B. Mencari posisi kolom di Sheet Pengajuan (Agar dinamis)
      const colID = getColumnIndex(sheet, CONFIG.COL_HEADERS.ID_UNIK);
      const colAtasan = getColumnIndex(sheet, CONFIG.COL_HEADERS.STATUS_ATASAN);
      const colHR = getColumnIndex(sheet, CONFIG.COL_HEADERS.STATUS_HR);
      
      // C. Mengisi data ke Sheet Pengajuan (Aksi setValue hanya terjadi di sheet ini)
      if (colID) sheet.getRange(row, colID).setValue(idUnik);
      if (colAtasan) sheet.getRange(row, colAtasan).setValue("Pending");
      if (colHR) sheet.getRange(row, colHR).setValue("Pending");

      // D. Menamai Ulang File di Pengajuan (Format: ID_Nama.ext)
      const linkFile = responses[CONFIG.COL_HEADERS.FILE_PENGAJUAN] ? responses[CONFIG.COL_HEADERS.FILE_PENGAJUAN][0] : "";
      const namaUser = responses[CONFIG.COL_HEADERS.NAMA] ? responses[CONFIG.COL_HEADERS.NAMA][0] : "TanpaNama";
      
      if (linkFile !== "") {
        executeRename(linkFile, idUnik, namaUser);
      }
      
      return; // SKRIP BERHENTI DI SINI agar tidak masuk ke logika Realisasi
    }

    // --- BLOK KHUSUS REALISASI ---
    if (sheetName === CONFIG.SHEET_REALISASI) {
      
      // A. Mengambil ID Unik yang diketik Karyawan di Form Realisasi
      const idTerdaftar = responses[CONFIG.COL_HEADERS.ID_UNIK] ? responses[CONFIG.COL_HEADERS.ID_UNIK][0] : "REKAP";
      
      // B. Mengambil Nama Karyawan
      const namaUser = responses[CONFIG.COL_HEADERS.NAMA] ? responses[CONFIG.COL_HEADERS.NAMA][0] : "User";
      
      // C. Menamai Ulang File Bukti di Realisasi (Format: ID_Nama.ext)
      const linkFile = responses[CONFIG.COL_HEADERS.FILE_REALISASI] ? responses[CONFIG.COL_HEADERS.FILE_REALISASI][0] : "";
      
      if (linkFile !== "") {
        executeRename(linkFile, idTerdaftar, namaUser);
      }
      
      return; // SKRIP BERHENTI DI SINI
    }

  } catch (err) {
    // Mencatat error di Logger Google Apps Script (bisa dicek di tab Executions)
    Logger.log("Error Terdeteksi: " + err.toString());
  }
}

/**
 * FUNGSI EKSEKUSI RENAME (Terpisah agar rapi)
 * Bertugas mengganti nama file di Google Drive
 */
function executeRename(url, id, nama) {
  // Regex untuk mengambil rangkaian kode ID File dari link Google Drive
  const fileIdMatch = url.match(/[-\w]{25,}/);
  
  if (fileIdMatch) {
    const file = DriveApp.getFileById(fileIdMatch[0]); // Mengakses file di Drive
    const ext = file.getName().split('.').pop();      // Mempertahankan ekstensi file asli (.jpg, .png, dsb)
    
    // Memberikan nama baru sesuai kebutuhan Audit
    const fileNameBaru = id + "_" + nama + "." + ext;
    file.setName(fileNameBaru);
  }
}